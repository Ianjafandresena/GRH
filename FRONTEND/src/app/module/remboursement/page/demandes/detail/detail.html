<div class="page-container">
    <div class="page-header">
        <button class="btn btn-secondary" (click)="goBack()">â† Retour</button>
        <h1>Demande #{{ demande?.rem_code }}</h1>
    </div>

    <div class="error-message" *ngIf="errorMsg">{{ errorMsg }}</div>
    <div class="loading" *ngIf="loading">Chargement...</div>

    <div class="detail-card" *ngIf="demande && !loading">
        <!-- En-tÃªte -->
        <div class="header-info">
            <div class="num-demande">{{ demande.rem_num || 'NÂ°---' }}</div>
            <span class="badge badge-type" *ngIf="demande.rem_is_centre" style="background: #17a2b8;">ğŸ¥ Centre</span>
            <span class="badge badge-type" *ngIf="!demande.rem_is_centre" style="background: #6c757d;">ğŸ‘¤ Agent</span>
            <span class="badge" [class]="'badge-' + (demande.eta_libelle || 'default')">
                {{ demande.eta_libelle || 'N/A' }}
            </span>
        </div>

        <!-- Infos Agent -->
        <div class="section">
            <h3>Agent demandeur</h3>
            <div class="info-row"><span class="label">Nom:</span><span>{{ demande.nom_emp }} {{ demande.prenom_emp
                    }}</span></div>
            <div class="info-row"><span class="label">Matricule:</span><span>{{ demande.matricule }}</span></div>
            <div class="info-row"><span class="label">Direction:</span><span>{{ demande.direction }}</span></div>
            <div class="info-row"><span class="label">Fonction:</span><span>{{ demande.fonction }}</span></div>
        </div>

        <!-- Infos BÃ©nÃ©ficiaire/Malade -->
        <div class="section">
            <h3>BÃ©nÃ©ficiaire</h3>
            <div class="info-row"><span class="label">NÂ° PEC:</span><span>{{ demande.pec_num || '-' }}</span></div>
            <div class="info-row"><span class="label">Nom:</span><span>{{ demande.beneficiaire_nom || demande.nom_malade
                    || '-' }}</span></div>
            <div class="info-row"><span class="label">Lien:</span><span>{{ demande.beneficiaire_lien ||
                    demande.lien_malade || '-' }}</span></div>
            <div class="info-row"><span class="label">Centre de santÃ©:</span><span>{{ demande.cen_nom || '-' }}</span>
            </div>
        </div>

        <!-- Montant -->
        <div class="section">
            <h3>Montant</h3>
            <div class="info-row">
                <span class="label">DemandÃ©:</span>
                <span class="amount">{{ demande.rem_montant | number:'1.2-2' }} Ar</span>
            </div>
            <div class="info-row" *ngIf="demande.montant_valide">
                <span class="label">ValidÃ©:</span>
                <span class="amount">{{ demande.montant_valide | number:'1.2-2' }} Ar</span>
            </div>
        </div>

        <!-- PiÃ¨ces fournies -->
        <div class="section">
            <h3>PiÃ¨ces fournies</h3>
            <div class="pieces-list">
                <span class="piece" [class.checked]="demande.has_ordonnance">â˜ Ordonnance</span>
                <span class="piece" [class.checked]="demande.has_facture">â˜ Facture(s)</span>
                <span class="piece" [class.checked]="demande.has_prise_en_charge">â˜ Prise en charge</span>
            </div>
            <div class="info-row" *ngIf="demande.pec_reference">
                <span class="label">RÃ©f PEC:</span><span>{{ demande.pec_reference }}</span>
            </div>
        </div>

        <!-- Historique -->
        <div class="section" *ngIf="historique.length">
            <h3>Historique des validations</h3>
            <ul class="history-list">
                <li *ngFor="let h of historique">{{ h.sin_dem_code }} - {{ h.date_ }}</li>
            </ul>
        </div>

        <!-- Rejet -->
        <div class="section rejet" *ngIf="demande.motif_rejet">
            <h3>Motif de rejet</h3>
            <p>{{ demande.motif_rejet }}</p>
        </div>

        <!-- Actions selon Ã©tat -->
        <div class="actions">
            <button class="btn btn-success" *ngIf="demande.eta_libelle === 'SOUMIS'" (click)="validerRRH()">
                âœ“ Valider RRH
            </button>
            <button class="btn btn-success" *ngIf="demande.eta_libelle === 'VALIDE_RRH'" (click)="validerDAAF()">
                âœ“ Valider DAAF
            </button>
            <button class="btn btn-primary" *ngIf="demande.eta_libelle === 'VALIDE_DAAF'" (click)="engager()">
                ğŸ“‹ Engager
            </button>
            <button class="btn btn-success" *ngIf="demande.eta_libelle === 'ENGAGE'" (click)="payer()">
                ğŸ’° Payer
            </button>

            <button class="btn btn-danger" *ngIf="['SOUMIS','VALIDE_RRH','VALIDE_DAAF'].includes(demande.eta_libelle)"
                (click)="rejeter()">
                âœ— Rejeter
            </button>

            <button class="btn btn-primary" *ngIf="demande.rem_status !== true && demande.rem_status !== 't'"
                (click)="traiter()">
                ğŸ“‹ Traiter
            </button>

            <button class="btn btn-secondary" (click)="downloadPdf()">ğŸ“„ PDF</button>
        </div>
    </div>
</div>