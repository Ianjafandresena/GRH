<div class="page-container">
  <div class="card filter-card">
    <div class="card-header-internal">
      <div class="title-group">
        <h1>Historique des Congés</h1>
        <p class="subtitle">Suivi et historique des demandes de congés</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-outline" routerLink="/conge/validation">
          <i class="fas fa-clipboard-check"></i> Validations
        </button>
        <button class="btn btn-primary" (click)="create()">
          <i class="fas fa-plus"></i> Nouveau congé
        </button>
      </div>
    </div>
    <div class="filter-row">
      <div class="form-group">
        <label>Date début</label>
        <input type="date" class="form-control" [(ngModel)]="start">
      </div>
      <div class="form-group">
        <label>Date fin</label>
        <input type="date" class="form-control" [(ngModel)]="end">
      </div>
      <div class="form-group">
        <label>Lieu</label>
        <div class="select2-container">
          <div class="input-wrapper">
            <input type="text" class="form-control" [(ngModel)]="lieu" (input)="filterRegions()"
              (focus)="onRegionFocus()" (blur)="onRegionBlur()" placeholder="Ex: Antananarivo">
          </div>
          <ul class="suggestions" *ngIf="showRegionDropdown && filteredRegions.length > 0">
            <li *ngFor="let region of filteredRegions" (mousedown)="selectRegion(region)">
              {{ region.reg_nom }}
            </li>
          </ul>
        </div>
      </div>
      <div class="actions-group">
        <button class="btn btn-primary" (click)="applyFilter()" [disabled]="loading">
          <i class="fas fa-filter"></i> Filtrer
        </button>
        <button class="btn btn-outline" (click)="reload()" title="Recharger">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>
    </div>

    <div class="export-row">
      <div class="left-actions">
        <button class="btn btn-outline" (click)="exportCsv()">
          <i class="fas fa-file-csv"></i> CSV
        </button>
        <button class="btn btn-outline" (click)="exportExcel()">
          <i class="fas fa-file-excel"></i> Excel
        </button>
      </div>
      <div class="right-actions">
        <label class="file-upload-btn">
          <input type="file" accept=".csv" (change)="importCsv($any($event.target).files[0])" hidden />
          <i class="fas fa-upload"></i> Importer CSV
        </label>
      </div>
    </div>
  </div>

  <div class="card table-card">
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>Employé</th>
            <th class="text-center">Date début</th>
            <th class="text-center">Date fin</th>
            <th class="text-center">Durée</th>
            <th>Type</th>
            <th>Référence</th>
            <th>Région</th>
            <th class="text-center">Statut</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let c of conges">
            <td>
              <div class="employee-cell">
                <span class="emp-name">{{ c.nom_emp }} {{ c.prenom_emp }}</span>
              </div>
            </td>
            <td class="text-center">{{ c.cng_debut | date:'dd/MM/yyyy' }}</td>
            <td class="text-center">{{ c.cng_fin | date:'dd/MM/yyyy' }}</td>
            <td class="text-center">
              <span class="badge badge-info">{{ c.cng_nb_jour }} j</span>
            </td>
            <td>{{ c.typ_appelation }}</td>
            <td><span class="ref-code">{{ c.typ_ref }}</span></td>
            <td>{{ c.nom_region }}</td>
            <td class="text-center">
              <span class="status-badge" [ngClass]="getStatusClass(c.cng_status)">
                {{ getStatusLabel(c.cng_status) }}
              </span>
            </td>
            <td class="text-end">
              <button class="btn-icon" (click)="openDetail(c.cng_code)" title="Voir détails">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20">
                  <path
                    d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" />
                </svg>
              </button>
            </td>
          </tr>
          <tr *ngIf="!loading && conges.length === 0">
            <td colspan="8" class="empty-state">
              <i class="fas fa-calendar-times"></i>
              <p>Aucun congé trouvé pour cette période</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div *ngIf="errorMsg" class="alert alert-danger mt-3">
      {{ errorMsg }}
    </div>
  </div>
</div>