<div class="page-container">
  <!-- ‚ûï NOUVEAU: Notification de succ√®s -->
  <div class="success-notification" *ngIf="successMsg">
    <i class="fas fa-check-circle"></i>
    <span>{{ successMsg }}</span>
    <button class="close-btn" (click)="successMsg = null">√ó</button>
  </div>

  <div class="card filter-card">
    <div class="card-header-internal">
      <div class="title-group">
        <h1>Historique des Absences</h1> <!-- üîÑ MODIFI√â -->
        <p class="subtitle">Suivi et historique des demandes de cong√©s et permissions</p> <!-- üîÑ MODIFI√â -->
      </div>
      <div class="header-actions">
        <button class="btn btn-outline" routerLink="/conge/validation">
          <i class="fas fa-clipboard-check"></i> Validations
        </button>
        <button class="btn btn-outline" routerLink="/conge/etat">
          <i class="fas fa-chart-bar"></i> √âtat de Cong√©
        </button>
        <button class="btn btn-primary" (click)="create()">
          <i class="fas fa-plus"></i> Nouveau cong√©
        </button>
      </div>
    </div>
    <div class="filter-row">
      <div class="form-group">
        <label>Date d√©but</label>
        <input type="date" class="form-control" [(ngModel)]="start">
      </div>
      <div class="form-group">
        <label>Date fin</label>
        <input type="date" class="form-control" [(ngModel)]="end">
      </div>
      <div class="form-group">
        <label>Lieu</label>
        <div class="select2-container">
          <div class="input-wrapper">
            <input type="text" class="form-control" [(ngModel)]="lieu" (input)="filterRegions()"
              (focus)="onRegionFocus()" (blur)="onRegionBlur()" placeholder="Ex: Antananarivo">
          </div>
          <ul class="suggestions" *ngIf="showRegionDropdown && filteredRegions.length > 0">
            <li *ngFor="let region of filteredRegions" (mousedown)="selectRegion(region)">
              {{ region.reg_nom }}
            </li>
          </ul>
        </div>
      </div>

      <!-- ‚ûï NOUVEAU: Filtre Type d'absence -->
      <div class="form-group">
        <label>Type d'absence</label>
        <select class="form-control" [(ngModel)]="absenceTypeFilter" (change)="applyFilter()">
          <option value="">Tous les types</option>
          <option value="conge">Cong√©s uniquement</option>
          <option value="permission">Permissions uniquement</option>
        </select>
      </div>

      <div class="actions-group">
        <button class="btn btn-primary" (click)="applyFilter()" [disabled]="loading">
          <i class="fas fa-filter"></i> Filtrer
        </button>
        <button class="btn btn-outline" (click)="reload()" title="Recharger">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>
    </div>

    <div class="export-row">
      <div class="left-actions">
        <button class="btn btn-outline" (click)="exportCsv()">
          <i class="fas fa-file-csv"></i> CSV
        </button>
        <button class="btn btn-outline" (click)="exportExcel()">
          <i class="fas fa-file-excel"></i> Excel
        </button>
      </div>
      <div class="right-actions">
        <label class="file-upload-btn">
          <input type="file" accept=".csv" (change)="importCsv($any($event.target).files[0])" hidden />
          <i class="fas fa-upload"></i> Importer CSV
        </label>
      </div>
    </div>
  </div>

  <div class="card table-card">
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>Employ√©</th>
            <th class="text-center">Type</th>
            <th class="text-center">Date d√©but</th>
            <th class="text-center">Date fin</th>
            <th class="text-center">Dur√©e</th>
            <th>Motif</th>
            <th class="text-center">Statut</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- üîÑ MODIFI√â: Boucle sur absences au lieu de conges -->
          <tr *ngFor="let item of absences">
            <td>
              <div class="employee-cell">
                <span class="emp-name">{{ item.nom_emp }} {{ item.prenom_emp }}</span>
              </div>
            </td>
            <!-- ‚ûï NOUVEAU: Colonne Type avec badge -->
            <td class="text-center">
              <span class="badge" [ngClass]="getAbsenceTypeClass(item)">
                {{ getAbsenceType(item) }}
              </span>
            </td>
            <td class="text-center">{{ (item.cng_debut || item.prm_debut) | date:'dd/MM/yyyy' }}</td>
            <td class="text-center">{{ (item.cng_fin || item.prm_fin) | date:'dd/MM/yyyy' }}</td>
            <td class="text-center">
              <span class="badge badge-info">
                {{ item.cng_nb_jour || (item.prm_duree ? (item.prm_duree / 8).toFixed(1) : '-') }} j
              </span>
            </td>
            <td>{{ item.typ_appelation || 'Permission' }}</td>
            <td class="text-center">
              <span class="status-badge" [ngClass]="getStatusClass(item.cng_status || item.prm_status)">
                {{ getStatusLabel(item.cng_status || item.prm_status) }}
              </span>
            </td>
            <td class="text-end">
              <button class="btn-icon" (click)="openDetail(item.cng_code || item.prm_code)" title="Voir d√©tails">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20">
                  <path
                    d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" />
                </svg>
              </button>
            </td>
          </tr>
          <tr *ngIf="!loading && absences.length === 0">
            <td colspan="8" class="empty-state">
              <i class="fas fa-calendar-times"></i>
              <p>Aucune absence trouv√©e pour cette p√©riode</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div *ngIf="errorMsg" class="alert alert-danger mt-3">
      {{ errorMsg }}
    </div>
  </div>
</div>