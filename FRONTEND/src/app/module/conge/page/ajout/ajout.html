<div class="container">
  <div class="card" style="max-width: 800px; margin: 0 auto;">
    <h2 style="margin-bottom: 1.5rem; color: var(--text-primary);">Nouvelle Demande de Cong√©</h2>

    <form *ngIf="!showRecap" [formGroup]="congeForm" (ngSubmit)="submit()" novalidate>

      <!-- Employ√© Selection -->
      <div style="margin-bottom: 1.5rem;">
        <label for="emp_search">Employ√©</label>
        <div style="position: relative;">
          <input id="emp_search" type="text" formControlName="emp_search" autocomplete="off"
            placeholder="Rechercher un employ√©..."
            [class.is-invalid]="congeForm.get('emp_search')?.invalid && congeForm.get('emp_search')?.touched">
          <ul class="suggestions"
            *ngIf="filteredEmployees.length && congeForm.get('emp_search')?.value && !selectedEmployee">
            <li *ngFor="let emp of filteredEmployees" (click)="selectEmployee(emp)">
              {{ emp.nom }} {{ emp.prenom }}
            </li>
          </ul>
        </div>
        <div *ngIf="selectedEmployee" style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">
          <strong>Matricule :</strong> {{ selectedEmployee.matricule }}
        </div>
      </div>

      <div class="form-row">
        <!-- Motif -->
        <div>
          <label for="typ_code">Motif du cong√©</label>
          <select id="typ_code" formControlName="typ_code" required>
            <option value="">-- S√©lectionner --</option>
            <option *ngFor="let t of typesConge" [value]="t.typ_code">{{ t.typ_appelation }}</option>
          </select>
        </div>

        <!-- R√©gion -->
        <div>
          <label for="region_search">R√©gion</label>
          <div style="position: relative;">
            <input id="region_search" type="text" formControlName="region_search" autocomplete="off"
              placeholder="Rechercher une r√©gion..." />
            <ul class="suggestions"
              *ngIf="filteredRegions.length && congeForm.get('region_search')?.value && !selectedRegion">
              <li *ngFor="let region of filteredRegions" (click)="selectRegion(region)">
                {{ region.reg_nom }}
              </li>
            </ul>
          </div>
          <div *ngIf="selectedRegion" style="margin-top: 0.25rem; font-size: 0.875rem; color: var(--text-secondary);">
            <small>S√©lectionn√© : {{ selectedRegion.reg_nom }}</small>
          </div>
        </div>
      </div>

      <div class="form-row">
        <!-- Dates -->
        <div>
          <label for="cng_debut">Date d√©but</label>
          <input type="date" id="cng_debut" formControlName="cng_debut" required>
        </div>
        <div>
          <label for="cng_fin">Date fin</label>
          <input type="date" id="cng_fin" formControlName="cng_fin" required>
        </div>
      </div>

      <!-- Info Solde & Dur√©e -->
      <div
        style="background: var(--bg-main); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1.5rem; border: 1px solid var(--border-light);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
          <span style="font-weight: 600; color: var(--text-secondary);">Dur√©e calcul√©e</span>
          <span style="font-size: 1.25rem; font-weight: 700; color: var(--stat-blue);">
            {{ calculatedNbJours !== null ? calculatedNbJours : '-' }} jours
          </span>
        </div>

        <div *ngIf="dernierSolde"
          style="border-top: 1px solid var(--border-medium); padding-top: 0.5rem; margin-top: 0.5rem; font-size: 0.875rem;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
            <div>D√©cision n¬∞ <strong>{{ numeroDecision }}</strong></div>
            <div>Ann√©e : <strong>{{ anneeSolde }}</strong></div>
            <div style="grid-column: span 2;">
              Solde restant : <strong [style.color]="joursRestants==0?'var(--stat-red)':'var(--stat-green)'">{{
                joursRestants }} jours</strong>
            </div>
          </div>
        </div>
      </div>

      <!-- Suppl√©ants -->
      <div formArrayName="interims" style="margin-bottom: 1.5rem;">
        <label style="margin-bottom: 0.75rem; display: block;">Suppl√©ant(s)</label>
        <div *ngFor="let group of interims.controls; let i=index" [formGroupName]="i" style="margin-bottom: 0.75rem;">
          <div style="display: flex; gap: 0.5rem;">
            <div style="position: relative; flex: 1;">
              <input type="text" formControlName="interim_search" placeholder="Rechercher un suppl√©ant..."
                autocomplete="off">
              <ul class="suggestions"
                *ngIf="filteredInterims[i]?.length && group.get('interim_search')?.value && !group.get('selectedInterim')?.value">
                <li *ngFor="let emp of filteredInterims[i]" (click)="selectInterim(i, emp)">
                  {{ emp.nom }} {{ emp.prenom }} <small>({{ emp.matricule }})</small>
                </li>
              </ul>
            </div>
            <button class="btn btn-danger" type="button" *ngIf="interims.length>1" (click)="removeInterimField(i)"
              style="padding: 0.5rem;">
              üóëÔ∏è
            </button>
          </div>
          <div *ngIf="group.get('selectedInterim')?.value"
            style="margin-top: 0.25rem; font-size: 0.875rem; color: var(--stat-green);">
            ‚úì {{ group.get('selectedInterim')?.value.nom }} {{ group.get('selectedInterim')?.value.prenom }}
          </div>
        </div>
        <button class="btn btn-primary" type="button" (click)="addInterimField()"
          style="width: 100%; justify-content: center; background: transparent; color: var(--stat-blue); border: 1px dashed var(--stat-blue);">
          + Ajouter un suppl√©ant
        </button>
      </div>

      <div *ngIf="errorMsg" class="errorMsg">{{ errorMsg }}</div>

      <div class="form-actions" style="justify-content: flex-end;">
        <button class="btn btn-primary" type="submit"
          [disabled]="loading || !selectedEmployee || !selectedRegion || calculatedNbJours == null || calculatedNbJours < 1">
          <span *ngIf="!loading">Enregistrer la demande</span>
          <span *ngIf="loading">Enregistrement...</span>
        </button>
      </div>
    </form>

    <!-- FICHE RECAPITULATIVE -->
    <div *ngIf="showRecap">
      <div style="text-align: center; margin-bottom: 1.5rem;">
        <h3 style="color: var(--stat-blue);">R√©capitulatif de la demande</h3>
        <p style="color: var(--text-secondary);">Veuillez v√©rifier les informations avant confirmation</p>
      </div>

      <div style="background: var(--bg-main); padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 1.5rem;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div>
            <small style="color: var(--text-secondary);">Employ√©</small>
            <div style="font-weight: 600;">{{ lastCongeDraft.nom_emp }}</div>
            <div style="font-size: 0.875rem;">{{ lastCongeDraft.matricule }}</div>
          </div>
          <div>
            <small style="color: var(--text-secondary);">R√©gion</small>
            <div style="font-weight: 600;">{{ lastCongeDraft.nom_region }}</div>
          </div>

          <div
            style="grid-column: span 2; border-top: 1px solid var(--border-medium); margin-top: 0.5rem; padding-top: 0.5rem;">
          </div>

          <div>
            <small style="color: var(--text-secondary);">Motif</small>
            <div style="font-weight: 600;">{{ motifLibelle }}</div>
          </div>
          <div>
            <small style="color: var(--text-secondary);">Dur√©e</small>
            <div style="font-weight: 600;">{{ lastCongeDraft.cng_nb_jour }} jours</div>
          </div>

          <div style="grid-column: span 2;">
            <small style="color: var(--text-secondary);">P√©riode</small>
            <div style="font-weight: 600;">Du {{ lastCongeDraft.cng_debut | date:'dd/MM/yyyy' }} au {{
              lastCongeDraft.cng_fin | date:'dd/MM/yyyy' }}</div>
          </div>

          <div
            style="grid-column: span 2; border-top: 1px solid var(--border-medium); margin-top: 0.5rem; padding-top: 0.5rem;">
          </div>

          <div>
            <small style="color: var(--text-secondary);">Solde utilis√©</small>
            <div>D√©cision {{ lastCongeDraft.numeroDecision }} ({{ lastCongeDraft.anneeSolde }})</div>
          </div>
          <div>
            <small style="color: var(--text-secondary);">Reste apr√®s</small>
            <div [style.color]="lastCongeDraft.joursRestants==0 ? 'var(--stat-red)' : 'var(--stat-green)'"
              style="font-weight: 700;">
              {{ lastCongeDraft.joursRestants }} jours
            </div>
          </div>

          <div
            style="grid-column: span 2; border-top: 1px solid var(--border-medium); margin-top: 0.5rem; padding-top: 0.5rem;">
          </div>

          <div style="grid-column: span 2;">
            <small style="color: var(--text-secondary);">Suppl√©ants</small>
            <ul style="margin: 0; padding-left: 1.25rem;">
              <li *ngFor="let interim of lastCongeDraft.interims ? lastCongeDraft.interims : []">
                {{ interim?.nom }} {{ interim?.prenom }} <span *ngIf="interim?.matricule">({{ interim?.matricule
                  }})</span>
              </li>
              <li *ngIf="!lastCongeDraft.interims || lastCongeDraft.interims.length === 0"
                style="font-style: italic; color: var(--text-muted);">Aucun suppl√©ant</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="form-actions" style="justify-content: flex-end; gap: 1rem;">
        <button class="btn btn-danger" type="button" (click)="annulerRecap()"
          style="background: transparent; color: var(--stat-red); border: 1px solid var(--stat-red);">
          Modifier
        </button>
        <button class="btn btn-success" type="button" (click)="confirmEnvoi()" [disabled]="loading">
          Confirmer la demande
        </button>
      </div>
      <div *ngIf="errorMsg" class="errorMsg">{{ errorMsg }}</div>
    </div>
  </div>
</div>