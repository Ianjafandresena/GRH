<div class="dashboard">

  <!-- Stats Cards -->

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card blue">
      <div class="stat-header">
        <div class="stat-icon"><mat-icon>groups</mat-icon></div>
        <div class="stat-value">{{ stats.totalEmployees }}</div>
      </div>
      <div class="stat-info">
        <div class="stat-label">Total Employés</div>
      </div>
      <div class="stat-footer">
        <div class="stat-subtitle">{{ stats.employeesActive }} actifs</div>
        <div class="stat-change"
          [ngClass]="{'positive': stats.employeesChange.includes('↑'), 'negative': stats.employeesChange.includes('↓')}">
          {{ stats.employeesChange }}
        </div>
      </div>
    </div>

    <div class="stat-card cyan">
      <div class="stat-header">
        <div class="stat-icon"><mat-icon>calendar_today</mat-icon></div>
        <div class="stat-value">{{ stats.congesEnCours }}</div>
      </div>
      <div class="stat-info">
        <div class="stat-label">Congés en cours</div>
      </div>
      <div class="stat-footer">
        <div class="stat-subtitle">{{ stats.congesPrevision }}</div>
        <div class="stat-change"
          [ngClass]="{'positive': stats.congesChange.includes('↑'), 'negative': stats.congesChange.includes('↓')}">
          {{ stats.congesChange }}
        </div>
      </div>
    </div>

    <div class="stat-card yellow">
      <div class="stat-header">
        <div class="stat-icon"><mat-icon>schedule</mat-icon></div>
        <div class="stat-value">{{ stats.permissions }}</div>
      </div>
      <div class="stat-info">
        <div class="stat-label">Permissions</div>
      </div>
      <div class="stat-footer">
        <div class="stat-subtitle">{{ stats.permissionsStatus }}</div>
      </div>
    </div>

    <!-- NEW: Pending Requests Card -->
    <div class="stat-card green">
      <div class="stat-header">
        <div class="stat-icon"><mat-icon>pending_actions</mat-icon></div>
        <div class="stat-value">{{ pendingRequests().count }}</div>
      </div>
      <div class="stat-info">
        <div class="stat-label">Remboursements</div>
      </div>
      <div class="stat-footer">
        <div class="stat-subtitle">À traiter</div>
        <div class="stat-amount">{{ pendingRequests().total | number:'1.0-0' }} Ar</div>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="charts-grid">
    <!-- Existing Chart -->
    <div class="chart-card">
      <h3>Évolution des Congés et Permissions</h3>
      <div class="chart-placeholder" (mousemove)="onChartMouseMove($event)" (mouseleave)="onChartMouseLeave()">

        <!-- Tooltip Element -->
        <div class="chart-tooltip" *ngIf="hoveredIndex !== -1" [style.left.px]="tooltipX" [style.top.px]="tooltipY">
          <div class="tooltip-header">{{ tooltipData.label }}</div>
          <div class="tooltip-row">
            <span class="dot blue"></span>
            <span>Congés: <strong>{{ tooltipData.conges }}</strong></span>
          </div>
          <div class="tooltip-row">
            <span class="dot green"></span>
            <span>Perms: <strong>{{ tooltipData.permissions }}</strong></span>
          </div>
        </div>

        <svg viewBox="0 0 440 220" class="line-chart">
          <defs>
            <linearGradient id="gradient1" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" style="stop-color:rgba(59, 130, 246, 0.4);stop-opacity:1" />
              <stop offset="100%" style="stop-color:rgba(59, 130, 246, 0.1);stop-opacity:1" />
            </linearGradient>
            <linearGradient id="gradient2" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" style="stop-color:rgba(16, 185, 129, 0.4);stop-opacity:1" />
              <stop offset="100%" style="stop-color:rgba(16, 185, 129, 0.1);stop-opacity:1" />
            </linearGradient>
          </defs>

          <!-- Y-axis Labels & Horizontal Grid Lines -->
          <g *ngFor="let tick of yAxisTicks">
            <!-- Label (Left side) -->
            <text x="25" [attr.y]="tick.y + 4" font-size="10" fill="var(--text-muted)" text-anchor="end">{{ tick.value |
              number:'1.0-0' }}</text>

            <!-- Grid Line (aligned with label) -->
            <!-- Don't draw line for the x-axis (value 0, which is at y=200, or maybe we do want it?) -->
            <!-- User had a line at 200. Let's keep it. -->
            <line x1="30" [attr.y1]="tick.y" x2="440" [attr.y2]="tick.y" stroke="var(--border-light)"
              stroke-dasharray="3" opacity="0.5" />
          </g>

          <!-- Vertical Grid Lines (for each month) -->
          <g *ngFor="let label of chartLabels; let i = index">
            <line [attr.x1]="getX(i) + 30" y1="10" [attr.x2]="getX(i) + 30" y2="200" stroke="var(--border-light)"
              stroke-dasharray="3" opacity="0.3" />
          </g>

          <!-- Chart Content Group (Shifted right for Y-axis) -->
          <g transform="translate(30, 0)">
            <!-- Conges (Blue) -->
            <path [attr.d]="congeAreaPath" fill="url(#gradient1)" />
            <path [attr.d]="congePath" fill="none" stroke="#3B82F6" stroke-width="2" />

            <!-- Permissions (Green) -->
            <path [attr.d]="permissionAreaPath" fill="url(#gradient2)" />
            <path [attr.d]="permissionPath" fill="none" stroke="#10B981" stroke-width="2" />

            <!-- Active Vertical Line (Solid, like image) -->
            <line *ngIf="hoveredIndex !== -1" [attr.x1]="getX(hoveredIndex)" y1="10" [attr.x2]="getX(hoveredIndex)"
              y2="200" stroke="var(--text-secondary)" stroke-width="1" />

            <!-- Hover Points (Filled with color, background stroke) -->
            <circle *ngIf="hoveredIndex !== -1" [attr.cx]="getX(hoveredIndex)"
              [attr.cy]="getY(chartData.conges[hoveredIndex])" r="5" fill="#3B82F6" stroke="var(--bg-card)"
              stroke-width="2" />
            <circle *ngIf="hoveredIndex !== -1" [attr.cx]="getX(hoveredIndex)"
              [attr.cy]="getY(chartData.permissions[hoveredIndex])" r="5" fill="#10B981" stroke="var(--bg-card)"
              stroke-width="2" />

            <!-- X-axis Labels (Shifted) -->
            <g *ngFor="let label of chartLabels; let i = index">
              <text [attr.x]="getX(i)" y="215" font-size="10" fill="var(--text-secondary)" text-anchor="middle">{{ label
                }}</text>
            </g>
          </g>
        </svg>
      </div>
    </div>

    <!-- NEW: Employees On Leave Widget -->
    <div class="on-leave-widget">
      <h3>En congé actuellement</h3>
      <div class="employee-list">
        @if (employeesOnLeave().length === 0) {
        <div class="empty-state">Aucun employé en congé</div>
        }
        @for (emp of employeesOnLeave(); track emp.emp_code) {
        <div class="employee-item">
          <div class="avatar">{{ emp.emp_nom?.charAt(0) || '?' }}</div>
          <div class="info">
            <div class="name">{{ emp.emp_nom }} {{ emp.emp_prenom }}</div>
            <div class="meta">{{ emp.typ_appelation || 'Congé' }}</div>
          </div>
        </div>
        }
      </div>
    </div>
  </div>

  <!-- NEW: Bottom Section - Donut Chart + Recent Activity -->
  <div class="bottom-grid">
    <!-- Donut Chart -->
    <div class="chart-card donut-card">
      <h3>Répartition Remboursements</h3>
      <div class="donut-container">
        <svg viewBox="0 0 200 200" class="donut-chart">
          <!-- Simple donut using circles -->
          <circle cx="100" cy="100" r="80" fill="none" stroke="#e5e7eb" stroke-width="30" />

          <!-- Approved segment (green) -->
          <circle cx="100" cy="100" r="80" fill="none" stroke="#10B981" stroke-width="30"
            [attr.stroke-dasharray]="(donutData().stats.approuve / donutData().stats.total * 502.65) + ' 502.65'"
            transform="rotate(-90 100 100)" />

          <!-- Pending segment (yellow) - offset by approved -->
          <circle cx="100" cy="100" r="80" fill="none" stroke="#F59E0B" stroke-width="30"
            [attr.stroke-dasharray]="(donutData().stats.en_attente / donutData().stats.total * 502.65) + ' 502.65'"
            [attr.stroke-dashoffset]="-(donutData().stats.approuve / donutData().stats.total * 502.65)"
            transform="rotate(-90 100 100)" />

          <!-- Center text -->
          <text x="100" y="95" text-anchor="middle" font-size="14" fill="var(--text-muted)">En attente</text>
          <text x="100" y="115" text-anchor="middle" font-size="20" font-weight="600" fill="var(--text-primary)">
            {{ donutData().stats.en_attente }}
          </text>
        </svg>

        <div class="donut-legend">
          <div class="legend-item">
            <span class="dot" style="background: #10B981;"></span>
            <span>Approuvés ({{ donutData().stats.approuve }})</span>
          </div>
          <div class="legend-item">
            <span class="dot" style="background: #F59E0B;"></span>
            <span>En attente ({{ donutData().stats.en_attente }})</span>
          </div>
          <div class="legend-total">
            Total: {{ donutData().montants.en_attente | number:'1.0-0' }} Ar
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Activity Feed -->
    <div class="activity-widget">
      <h3>Activité Récente</h3>
      <div class="timeline">
        @if (recentActivity().length === 0) {
        <div class="empty-state">Aucune activité récente</div>
        }
        @for (activity of recentActivity(); track $index) {
        <div class="activity-item">
          <div class="icon" [class.conge]="activity.type === 'conge'"
            [class.remboursement]="activity.type === 'remboursement'">
            <mat-icon>{{ activityIcon(activity.type) }}</mat-icon>
          </div>
          <div class="content">
            <div class="title">{{ activity.label || 'Action' }}</div>
            <div class="meta">
              {{ activity.emp_nom }} {{ activity.emp_prenom }}
              <span class="badge" [class]="activity.status.toLowerCase()">{{ activity.status }}</span>
            </div>
            <div class="time">{{ formatTime(activity.date) }}</div>
          </div>
        </div>
        }
      </div>
    </div>
  </div>
</div>